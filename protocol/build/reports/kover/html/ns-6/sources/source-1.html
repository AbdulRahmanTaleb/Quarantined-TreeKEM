


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>protocol Coverage Report > ResumptionKt</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: protocol<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.github.traderjoe95.mls.protocol.group.resumption</a>
</div>

<h1>Coverage Summary for Class: ResumptionKt (com.github.traderjoe95.mls.protocol.group.resumption)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ResumptionKt</td>
<td class="coverageStat">
  <span class="percent">
    11.1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.7%
  </span>
  <span class="absValue">
    (1/58)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.7%
  </span>
  <span class="absValue">
    (1/153)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.2%
  </span>
  <span class="absValue">
    (3/1225)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ResumptionKt$branchGroup$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ResumptionKt$branchGroup$3</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ResumptionKt$resumeReInit$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ResumptionKt$resumeReInit$3</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ResumptionKt$triggerReInit$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ResumptionKt$validateBranch$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ResumptionKt$validateReInit$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ResumptionKt$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    11.1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.7%
  </span>
  <span class="absValue">
    (1/58)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.7%
  </span>
  <span class="absValue">
    (1/153)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.2%
  </span>
  <span class="absValue">
    (3/1225)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.github.traderjoe95.mls.protocol.group.resumption
&nbsp;
&nbsp;import arrow.core.Either
&nbsp;import arrow.core.raise.Raise
&nbsp;import arrow.core.raise.either
&nbsp;import com.github.traderjoe95.mls.protocol.crypto.CipherSuite
&nbsp;import com.github.traderjoe95.mls.protocol.error.BranchError
&nbsp;import com.github.traderjoe95.mls.protocol.error.BranchJoinError
&nbsp;import com.github.traderjoe95.mls.protocol.error.ReInitError
&nbsp;import com.github.traderjoe95.mls.protocol.error.ReInitJoinError
&nbsp;import com.github.traderjoe95.mls.protocol.error.ResumptionJoinError
&nbsp;import com.github.traderjoe95.mls.protocol.error.WelcomeJoinError
&nbsp;import com.github.traderjoe95.mls.protocol.group.GroupContext
&nbsp;import com.github.traderjoe95.mls.protocol.group.GroupState
&nbsp;import com.github.traderjoe95.mls.protocol.group.newGroup
&nbsp;import com.github.traderjoe95.mls.protocol.group.prepareCommit
&nbsp;import com.github.traderjoe95.mls.protocol.message.KeyPackage
&nbsp;import com.github.traderjoe95.mls.protocol.message.MessageOptions
&nbsp;import com.github.traderjoe95.mls.protocol.message.UsePublicMessage
&nbsp;import com.github.traderjoe95.mls.protocol.psk.PreSharedKeyId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskUsage
&nbsp;import com.github.traderjoe95.mls.protocol.service.AuthenticationService
&nbsp;import com.github.traderjoe95.mls.protocol.service.DeliveryService
&nbsp;import com.github.traderjoe95.mls.protocol.service.authenticateCredentials
&nbsp;import com.github.traderjoe95.mls.protocol.tree.LeafIndex
&nbsp;import com.github.traderjoe95.mls.protocol.tree.RatchetTreeOps
&nbsp;import com.github.traderjoe95.mls.protocol.tree.nonBlankLeafNodeIndices
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupContextExtension
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupContextExtensions
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupId
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Add
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.PreSharedKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.ReInit
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.ProtocolVersion
&nbsp;
<b class="nc">&nbsp;suspend fun &lt;Identity : Any&gt; GroupState.Active.triggerReInit(</b>
&nbsp;  authenticationService: AuthenticationService&lt;Identity&gt;,
<b class="nc">&nbsp;  groupId: GroupId? = null,</b>
<b class="nc">&nbsp;  protocolVersion: ProtocolVersion = this.protocolVersion,</b>
<b class="nc">&nbsp;  cipherSuite: CipherSuite = this.cipherSuite,</b>
<b class="nc">&nbsp;  extensions: GroupContextExtensions = this.extensions,</b>
&nbsp;  authenticatedData: ByteArray = byteArrayOf(),
<b class="nc">&nbsp;  messageOptions: MessageOptions = UsePublicMessage,</b>
&nbsp;): Either&lt;ReInitError, TriggerReInitResult&gt; =
<b class="nc">&nbsp;  either {</b>
<b class="nc">&nbsp;    val newGroupId = groupId ?: GroupId.new()</b>
&nbsp;
<b class="nc">&nbsp;    val oldGroupResult =</b>
<b class="nc">&nbsp;      prepareCommit(</b>
<b class="nc">&nbsp;        listOf(ReInit(newGroupId, protocolVersion, cipherSuite, extensions)),</b>
<b class="nc">&nbsp;        authenticationService,</b>
<b class="nc">&nbsp;        authenticatedData = authenticatedData,</b>
<b class="nc">&nbsp;        messageOptions = messageOptions,</b>
<b class="nc">&nbsp;      ).bind()</b>
&nbsp;
<b class="nc">&nbsp;    TriggerReInitResult(oldGroupResult.newGroupState.coerceSuspended(), oldGroupResult.commit)</b>
&nbsp;  }
&nbsp;
&nbsp;suspend fun &lt;Identity : Any&gt; GroupState.Suspended.resumeReInit(
&nbsp;  ownKeyPackage: KeyPackage.Private,
&nbsp;  authenticationService: AuthenticationService&lt;Identity&gt;,
&nbsp;  deliveryService: DeliveryService&lt;Identity&gt;,
<b class="nc">&nbsp;  inlineTree: Boolean = true,</b>
<b class="nc">&nbsp;  forcePath: Boolean = false,</b>
&nbsp;): Either&lt;ReInitError, ResumptionResult&gt; =
<b class="nc">&nbsp;  either {</b>
<b class="nc">&nbsp;    resumeReInit(</b>
<b class="nc">&nbsp;      ownKeyPackage,</b>
<b class="nc">&nbsp;      deliveryService.getKeyPackages(</b>
<b class="nc">&nbsp;        reInit.protocolVersion,</b>
<b class="nc">&nbsp;        reInit.cipherSuite,</b>
<b class="nc">&nbsp;        authenticationService.authenticateCredentials(</b>
<b class="nc">&nbsp;          tree.leaves</b>
<b class="nc">&nbsp;            .filterIndexed { idx, _ -&gt; idx != leafIndex.value.toInt() }</b>
<b class="nc">&nbsp;            .filterNotNull(),</b>
<b class="nc">&nbsp;        ).bindAll(),</b>
<b class="nc">&nbsp;      ).values.bindAll(),</b>
<b class="nc">&nbsp;      authenticationService,</b>
<b class="nc">&nbsp;      inlineTree,</b>
<b class="nc">&nbsp;      forcePath,</b>
<b class="nc">&nbsp;    ).bind()</b>
&nbsp;  }
&nbsp;
&nbsp;suspend fun &lt;Identity : Any&gt; GroupState.Suspended.resumeReInit(
&nbsp;  ownKeyPackage: KeyPackage.Private,
&nbsp;  otherKeyPackages: List&lt;KeyPackage&gt;,
&nbsp;  authenticationService: AuthenticationService&lt;Identity&gt;,
<b class="nc">&nbsp;  inlineTree: Boolean = true,</b>
<b class="nc">&nbsp;  forcePath: Boolean = false,</b>
&nbsp;): Either&lt;ReInitError, ResumptionResult&gt; =
<b class="nc">&nbsp;  either {</b>
<b class="nc">&nbsp;    val newGroupInitial =</b>
<b class="nc">&nbsp;      newGroup(</b>
<b class="nc">&nbsp;        ownKeyPackage,</b>
<b class="nc">&nbsp;        *reInit.extensions.map { it as GroupContextExtension&lt;*&gt; }.toTypedArray(),</b>
<b class="nc">&nbsp;        protocolVersion = reInit.protocolVersion,</b>
<b class="nc">&nbsp;        cipherSuite = reInit.cipherSuite,</b>
<b class="nc">&nbsp;        groupId = reInit.groupId,</b>
<b class="nc">&nbsp;      ).bind()</b>
&nbsp;
<b class="nc">&nbsp;    val (newGroup, _, newMemberWelcome) =</b>
<b class="nc">&nbsp;      newGroupInitial.prepareCommit(</b>
<b class="nc">&nbsp;        otherKeyPackages.map(::Add) + PreSharedKey(ResumptionPskId.reInit(this@resumeReInit, reInit.cipherSuite)),</b>
<b class="nc">&nbsp;        authenticationService,</b>
<b class="nc">&nbsp;        inReInit = true,</b>
<b class="nc">&nbsp;        psks = this@resumeReInit,</b>
<b class="nc">&nbsp;        inlineTree = inlineTree,</b>
<b class="nc">&nbsp;        forcePath = forcePath,</b>
<b class="nc">&nbsp;      ).bind()</b>
&nbsp;
<b class="nc">&nbsp;    ResumptionResult(newGroup.coerceActive(), newMemberWelcome)</b>
&nbsp;  }
&nbsp;
&nbsp;suspend fun &lt;Identity : Any&gt; GroupState.Active.branchGroup(
&nbsp;  ownKeyPackage: KeyPackage.Private,
&nbsp;  otherMemberLeafIndices: List&lt;LeafIndex&gt;,
&nbsp;  authenticationService: AuthenticationService&lt;Identity&gt;,
&nbsp;  deliveryService: DeliveryService&lt;Identity&gt;,
<b class="nc">&nbsp;  groupId: GroupId? = null,</b>
<b class="nc">&nbsp;  extensions: GroupContextExtensions = this.extensions,</b>
<b class="nc">&nbsp;  inlineTree: Boolean = true,</b>
<b class="nc">&nbsp;  forcePath: Boolean = false,</b>
&nbsp;): Either&lt;BranchError, ResumptionResult&gt; =
<b class="nc">&nbsp;  either {</b>
<b class="nc">&nbsp;    val leafNodes =</b>
<b class="nc">&nbsp;      tree.leafNodeIndices</b>
<b class="nc">&nbsp;        .filter { it.leafIndex in (otherMemberLeafIndices - leafIndex) }</b>
<b class="nc">&nbsp;        .map { it to tree.leafNodeOrNull(it) }</b>
<b class="nc">&nbsp;        .partition { it.second != null }</b>
<b class="nc">&nbsp;        .let { (nonBlank, blank) -&gt;</b>
<b class="nc">&nbsp;          if (blank.isNotEmpty()) raise(BranchError.BlankLeavesIncluded(blank.map { it.first.leafIndex }))</b>
&nbsp;
<b class="nc">&nbsp;          nonBlank.map { it.second!! }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;    val keyPackages =</b>
<b class="nc">&nbsp;      deliveryService.getKeyPackages(</b>
<b class="nc">&nbsp;        protocolVersion,</b>
<b class="nc">&nbsp;        cipherSuite,</b>
<b class="nc">&nbsp;        authenticationService.authenticateCredentials(leafNodes).bindAll(),</b>
<b class="nc">&nbsp;      ).values.bindAll()</b>
&nbsp;
<b class="nc">&nbsp;    branchGroup(</b>
<b class="nc">&nbsp;      ownKeyPackage,</b>
<b class="nc">&nbsp;      keyPackages,</b>
<b class="nc">&nbsp;      authenticationService,</b>
<b class="nc">&nbsp;      groupId,</b>
<b class="nc">&nbsp;      extensions,</b>
<b class="nc">&nbsp;      inlineTree,</b>
<b class="nc">&nbsp;      forcePath,</b>
<b class="nc">&nbsp;    ).bind()</b>
&nbsp;  }
&nbsp;
&nbsp;suspend fun &lt;Identity : Any&gt; GroupState.Active.branchGroup(
&nbsp;  ownKeyPackage: KeyPackage.Private,
&nbsp;  otherMemberKeyPackages: List&lt;KeyPackage&gt;,
&nbsp;  authenticationService: AuthenticationService&lt;Identity&gt;,
<b class="nc">&nbsp;  groupId: GroupId? = null,</b>
<b class="nc">&nbsp;  extensions: GroupContextExtensions = this.extensions,</b>
<b class="nc">&nbsp;  inlineTree: Boolean = true,</b>
<b class="nc">&nbsp;  forcePath: Boolean = false,</b>
&nbsp;): Either&lt;BranchError, ResumptionResult&gt; =
<b class="nc">&nbsp;  either {</b>
<b class="nc">&nbsp;    val newGroupInitial =</b>
<b class="nc">&nbsp;      newGroup(</b>
<b class="nc">&nbsp;        ownKeyPackage,</b>
<b class="nc">&nbsp;        *extensions.toTypedArray(),</b>
<b class="nc">&nbsp;        groupId = groupId,</b>
<b class="nc">&nbsp;      ).bind()</b>
&nbsp;
<b class="nc">&nbsp;    val (newGroupAfterCommit, _, welcome) =</b>
<b class="nc">&nbsp;      newGroupInitial.prepareCommit(</b>
<b class="nc">&nbsp;        otherMemberKeyPackages.map(::Add) + PreSharedKey(ResumptionPskId.branch(this@branchGroup)),</b>
<b class="nc">&nbsp;        authenticationService,</b>
<b class="nc">&nbsp;        inBranch = true,</b>
<b class="nc">&nbsp;        psks = this@branchGroup,</b>
<b class="nc">&nbsp;        inlineTree = inlineTree,</b>
<b class="nc">&nbsp;        forcePath = forcePath,</b>
<b class="nc">&nbsp;      ).bind()</b>
&nbsp;
<b class="nc">&nbsp;    ResumptionResult(newGroupAfterCommit.coerceActive(), welcome)</b>
&nbsp;  }
&nbsp;
&nbsp;internal val PreSharedKeyId.isProtocolResumption: Boolean
<b class="pc">&nbsp;  get() = this is ResumptionPskId &amp;&amp; usage in ResumptionPskUsage.PROTOCOL_RESUMPTION</b>
&nbsp;
&nbsp;context(Raise&lt;WelcomeJoinError&gt;, AuthenticationService&lt;Identity&gt;)
&nbsp;internal suspend fun &lt;Identity : Any&gt; validateResumption(
&nbsp;  groupContext: GroupContext,
&nbsp;  tree: RatchetTreeOps,
&nbsp;  resumptionPsk: ResumptionPskId,
&nbsp;  resumptionGroup: GroupState,
<b class="nc">&nbsp;) = when (resumptionPsk.usage) {</b>
&nbsp;  ResumptionPskUsage.ReInit -&gt;
<b class="nc">&nbsp;    validateReInit(</b>
<b class="nc">&nbsp;      (resumptionGroup as GroupState.Suspended),</b>
<b class="nc">&nbsp;      groupContext,</b>
<b class="nc">&nbsp;      tree,</b>
<b class="nc">&nbsp;      resumptionPsk,</b>
&nbsp;    )
&nbsp;
<b class="nc">&nbsp;  ResumptionPskUsage.Branch -&gt; validateBranch(resumptionGroup, groupContext, tree)</b>
&nbsp;  else -&gt; { // Nothing to validate
&nbsp;  }
&nbsp;}
&nbsp;
&nbsp;context(Raise&lt;ReInitJoinError&gt;, AuthenticationService&lt;Identity&gt;)
&nbsp;internal suspend fun &lt;Identity : Any&gt; validateReInit(
&nbsp;  suspended: GroupState.Suspended,
&nbsp;  groupContext: GroupContext,
&nbsp;  tree: RatchetTreeOps,
&nbsp;  resumptionPsk: ResumptionPskId,
&nbsp;) {
<b class="nc">&nbsp;  if (suspended.epoch != resumptionPsk.pskEpoch) {</b>
<b class="nc">&nbsp;    raise(ReInitJoinError.UnexpectedEpoch(suspended.epoch, resumptionPsk.pskEpoch))</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  when {</b>
<b class="nc">&nbsp;    groupContext.groupId neq suspended.reInit.groupId -&gt;</b>
<b class="nc">&nbsp;      raise(ReInitJoinError.GroupIdMismatch(groupContext.groupId, suspended.reInit.groupId))</b>
&nbsp;
<b class="nc">&nbsp;    groupContext.protocolVersion != suspended.reInit.protocolVersion -&gt;</b>
<b class="nc">&nbsp;      raise(</b>
<b class="nc">&nbsp;        ResumptionJoinError.ProtocolVersionMismatch(</b>
<b class="nc">&nbsp;          groupContext.protocolVersion,</b>
<b class="nc">&nbsp;          suspended.reInit.protocolVersion,</b>
&nbsp;        ),
&nbsp;      )
&nbsp;
<b class="nc">&nbsp;    groupContext.cipherSuite != suspended.reInit.cipherSuite -&gt;</b>
<b class="nc">&nbsp;      raise(</b>
<b class="nc">&nbsp;        ResumptionJoinError.CipherSuiteMismatch(</b>
<b class="nc">&nbsp;          groupContext.cipherSuite,</b>
<b class="nc">&nbsp;          suspended.reInit.cipherSuite,</b>
&nbsp;        ),
&nbsp;      )
&nbsp;
<b class="nc">&nbsp;    groupContext.extensions != suspended.reInit.extensions -&gt;</b>
<b class="nc">&nbsp;      raise(</b>
<b class="nc">&nbsp;        ReInitJoinError.ExtensionsMismatch(</b>
<b class="nc">&nbsp;          groupContext.extensions,</b>
<b class="nc">&nbsp;          suspended.reInit.extensions.map { it as GroupContextExtension&lt;*&gt; },</b>
&nbsp;        ),
&nbsp;      )
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  tree.nonBlankLeafNodeIndices.forEach { leafNodeIdx -&gt;</b>
<b class="nc">&nbsp;    val leafNode = tree[leafNodeIdx]!!.asLeaf</b>
&nbsp;
<b class="nc">&nbsp;    suspended.tree.leaves</b>
<b class="nc">&nbsp;      .filterNotNull()</b>
<b class="nc">&nbsp;      .find { isSameClient(leafNode.credential, it.credential).bind() }</b>
<b class="nc">&nbsp;      ?: raise(ResumptionJoinError.NewMembersAdded)</b>
<b class="nc">&nbsp;  }</b>
&nbsp;
<b class="nc">&nbsp;  if (tree.nonBlankLeafNodeIndices.size &lt; suspended.tree.nonBlankLeafNodeIndices.size) {</b>
<b class="nc">&nbsp;    raise(ReInitJoinError.MembersMissing)</b>
&nbsp;  }
&nbsp;}
&nbsp;
&nbsp;context(Raise&lt;BranchJoinError&gt;, AuthenticationService&lt;Identity&gt;)
&nbsp;internal suspend fun &lt;Identity : Any&gt; validateBranch(
&nbsp;  originalGroup: GroupState,
&nbsp;  groupContext: GroupContext,
&nbsp;  tree: RatchetTreeOps,
&nbsp;) {
<b class="nc">&nbsp;  when {</b>
<b class="nc">&nbsp;    groupContext.protocolVersion != originalGroup.protocolVersion -&gt;</b>
<b class="nc">&nbsp;      raise(ResumptionJoinError.ProtocolVersionMismatch(groupContext.protocolVersion, originalGroup.protocolVersion))</b>
&nbsp;
<b class="nc">&nbsp;    groupContext.cipherSuite != originalGroup.cipherSuite -&gt;</b>
<b class="nc">&nbsp;      raise(ResumptionJoinError.CipherSuiteMismatch(groupContext.cipherSuite, originalGroup.cipherSuite))</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  tree.nonBlankLeafNodeIndices.forEach { leafNodeIdx -&gt;</b>
<b class="nc">&nbsp;    val leafNode = tree[leafNodeIdx]!!.asLeaf</b>
&nbsp;
<b class="nc">&nbsp;    originalGroup.tree.leaves</b>
<b class="nc">&nbsp;      .filterNotNull()</b>
<b class="nc">&nbsp;      .find { isSameClient(leafNode.credential, it.credential).bind() }</b>
<b class="nc">&nbsp;      ?: raise(ResumptionJoinError.NewMembersAdded)</b>
<b class="nc">&nbsp;  }</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-25 13:33</div>
</div>
</body>
</html>
