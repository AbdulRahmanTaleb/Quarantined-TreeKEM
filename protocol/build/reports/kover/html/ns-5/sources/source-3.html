


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>protocol Coverage Report > GroupState</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: protocol<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.github.traderjoe95.mls.protocol.group</a>
</div>

<h1>Coverage Summary for Class: GroupState (com.github.traderjoe95.mls.protocol.group)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">GroupState</td>
<td class="coverageStat">
  <span class="percent">
    12.5%
  </span>
  <span class="absValue">
    (1/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65%
  </span>
  <span class="absValue">
    (13/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    66.8%
  </span>
  <span class="absValue">
    (137/205)
  </span>
</td>
</tr>
  <tr>
    <td class="name">GroupState$Active</td>
<td class="coverageStat">
  <span class="percent">
    42.1%
  </span>
  <span class="absValue">
    (8/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    22.2%
  </span>
  <span class="absValue">
    (8/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    41.6%
  </span>
  <span class="absValue">
    (32/77)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    59.3%
  </span>
  <span class="absValue">
    (390/658)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$Active$messages$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$Active$process$2</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupState$Active$process$4</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupState$Active$secretTree$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$Active$storeProposal$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupState$Active$validations$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (5/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$CachedProposal</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (3/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (9/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    94.7%
  </span>
  <span class="absValue">
    (72/76)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$CachedUpdate</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$cipherSuite$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$Companion</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$confirmationTag$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$epoch$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$extensions$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$groupId$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$leafIndex$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$members$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$protocolVersion$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GroupState$Suspended</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    38.6%
  </span>
  <span class="absValue">
    (17/44)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    19.6%
  </span>
  <span class="absValue">
    (11/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    45.8%
  </span>
  <span class="absValue">
    (60/131)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    58.1%
  </span>
  <span class="absValue">
    (622/1071)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.github.traderjoe95.mls.protocol.group
&nbsp;
&nbsp;import arrow.core.Either
&nbsp;import arrow.core.raise.Raise
&nbsp;import arrow.core.raise.either
&nbsp;import arrow.core.raise.ensure
&nbsp;import com.github.traderjoe95.mls.codec.util.uSize
&nbsp;import com.github.traderjoe95.mls.protocol.crypto.CipherSuite
&nbsp;import com.github.traderjoe95.mls.protocol.crypto.ICipherSuite
&nbsp;import com.github.traderjoe95.mls.protocol.crypto.KeySchedule
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateUpdateError
&nbsp;import com.github.traderjoe95.mls.protocol.error.GroupActive
&nbsp;import com.github.traderjoe95.mls.protocol.error.GroupInfoError
&nbsp;import com.github.traderjoe95.mls.protocol.error.GroupSuspended
&nbsp;import com.github.traderjoe95.mls.protocol.error.InvalidCommit
&nbsp;import com.github.traderjoe95.mls.protocol.error.MessageRecipientError
&nbsp;import com.github.traderjoe95.mls.protocol.error.ProcessMessageError
&nbsp;import com.github.traderjoe95.mls.protocol.error.ProposalValidationError
&nbsp;import com.github.traderjoe95.mls.protocol.error.PskError
&nbsp;import com.github.traderjoe95.mls.protocol.message.AuthHandshakeContent
&nbsp;import com.github.traderjoe95.mls.protocol.message.GroupInfo
&nbsp;import com.github.traderjoe95.mls.protocol.message.GroupMessageFactory
&nbsp;import com.github.traderjoe95.mls.protocol.message.HandshakeMessage
&nbsp;import com.github.traderjoe95.mls.protocol.message.MlsHandshakeMessage
&nbsp;import com.github.traderjoe95.mls.protocol.psk.PreSharedKeyId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.PskLookup
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskId
&nbsp;import com.github.traderjoe95.mls.protocol.service.AuthenticationService
&nbsp;import com.github.traderjoe95.mls.protocol.tree.LeafIndex
&nbsp;import com.github.traderjoe95.mls.protocol.tree.RatchetTree
&nbsp;import com.github.traderjoe95.mls.protocol.tree.SecretTree
&nbsp;import com.github.traderjoe95.mls.protocol.types.Credential
&nbsp;import com.github.traderjoe95.mls.protocol.types.Extension
&nbsp;import com.github.traderjoe95.mls.protocol.types.ExternalPub
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupContextExtensions
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupId
&nbsp;import com.github.traderjoe95.mls.protocol.types.LeafNodeExtensions
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.HpkeKeyPair
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.HpkePrivateKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.Mac
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.Secret
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.SignatureKeyPair
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.SignaturePrivateKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.AuthenticatedContent
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Commit
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Proposal
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.ReInit
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.ProtocolVersion
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.SenderType.Member
&nbsp;import com.github.traderjoe95.mls.protocol.types.tree.LeafNode
&nbsp;import com.github.traderjoe95.mls.protocol.types.tree.UpdateLeafNode
&nbsp;import com.github.traderjoe95.mls.protocol.types.tree.leaf.Capabilities
&nbsp;import com.github.traderjoe95.mls.protocol.util.hex
&nbsp;import java.time.Instant
&nbsp;import com.github.traderjoe95.mls.protocol.types.RatchetTree as RatchetTreeExt
&nbsp;
<b class="fc">&nbsp;sealed class GroupState(</b>
<b class="fc">&nbsp;  val groupContext: GroupContext,</b>
<b class="fc">&nbsp;  val tree: RatchetTree,</b>
<b class="fc">&nbsp;  val keySchedule: KeySchedule,</b>
<b class="fc">&nbsp;) : ICipherSuite by groupContext.cipherSuite {</b>
<b class="pc">&nbsp;  val protocolVersion: ProtocolVersion by lazy { groupContext.protocolVersion }</b>
<b class="fc">&nbsp;  val cipherSuite: CipherSuite by lazy { groupContext.cipherSuite }</b>
&nbsp;
<b class="fc">&nbsp;  val groupId: GroupId by lazy { groupContext.groupId }</b>
<b class="fc">&nbsp;  val epoch: ULong by lazy { groupContext.epoch }</b>
&nbsp;
<b class="pc">&nbsp;  val extensions: GroupContextExtensions by lazy { groupContext.extensions }</b>
&nbsp;
<b class="pc">&nbsp;  val confirmationTag: Mac by lazy { mac(keySchedule.confirmationKey, groupContext.confirmedTranscriptHash) }</b>
&nbsp;
<b class="fc">&nbsp;  val leafIndex: LeafIndex by lazy { tree.leafIndex }</b>
&nbsp;
<b class="pc">&nbsp;  val members: List&lt;LeafNode&lt;*&gt;&gt; by lazy { tree.leaves.filterNotNull() }</b>
&nbsp;
<b class="nc">&nbsp;  fun isActive(): Boolean = this is Active</b>
&nbsp;
&nbsp;  context(Raise&lt;GroupSuspended&gt;)
<b class="nc">&nbsp;  inline fun &lt;T&gt; ensureActive(body: Active.() -&gt; T): T = ensureActive().body()</b>
&nbsp;
&nbsp;  context(Raise&lt;GroupSuspended&gt;)
<b class="nc">&nbsp;  fun ensureActive(): Active = (this as? Active) ?: raise(GroupSuspended(groupId))</b>
&nbsp;
&nbsp;  context(Raise&lt;GroupActive&gt;)
<b class="nc">&nbsp;  inline fun &lt;T&gt; ensureSuspended(body: Suspended.() -&gt; T): T = ensureSuspended().body()</b>
&nbsp;
&nbsp;  context(Raise&lt;GroupActive&gt;)
<b class="nc">&nbsp;  fun ensureSuspended(): Suspended = (this as? Suspended) ?: raise(GroupActive(groupId))</b>
&nbsp;
<b class="nc">&nbsp;  fun coerceActive(): Active = this as Active</b>
&nbsp;
<b class="nc">&nbsp;  fun coerceSuspended(): Suspended = this as Suspended</b>
&nbsp;
<b class="fc">&nbsp;  class Active internal constructor(</b>
&nbsp;    groupContext: GroupContext,
&nbsp;    tree: RatchetTree,
&nbsp;    keySchedule: KeySchedule,
<b class="fc">&nbsp;    val signaturePrivateKey: SignaturePrivateKey,</b>
<b class="fc">&nbsp;    private val cachedProposals: Map&lt;String, CachedProposal&gt; = mapOf(),</b>
<b class="fc">&nbsp;  ) : GroupState(groupContext, tree, keySchedule), SecretTree.Lookup, PskLookup {</b>
&nbsp;    @get:JvmName(&quot;secretTree&quot;)
<b class="fc">&nbsp;    val secretTree: SecretTree by lazy {</b>
<b class="nc">&nbsp;      SecretTree.create(</b>
<b class="nc">&nbsp;        cipherSuite,</b>
<b class="nc">&nbsp;        keySchedule.encryptionSecret,</b>
<b class="nc">&nbsp;        tree.leaves.uSize,</b>
&nbsp;      )
&nbsp;    }
&nbsp;
&nbsp;    @get:JvmName(&quot;messages&quot;)
<b class="pc">&nbsp;    val messages: GroupMessageFactory by lazy { GroupMessageFactory(this) }</b>
&nbsp;
&nbsp;    @get:JvmName(&quot;validations&quot;)
<b class="fc">&nbsp;    val validations: Validations by lazy { Validations(this) }</b>
&nbsp;
<b class="fc">&nbsp;    internal var cachedUpdate: CachedUpdate? = null</b>
&nbsp;
&nbsp;    context(Raise&lt;ProposalValidationError&gt;)
&nbsp;    private suspend fun storeProposal(proposal: AuthenticatedContent&lt;Proposal&gt;): Active =
<b class="fc">&nbsp;      Active(</b>
<b class="fc">&nbsp;        groupContext,</b>
<b class="fc">&nbsp;        tree,</b>
<b class="fc">&nbsp;        keySchedule,</b>
<b class="fc">&nbsp;        signaturePrivateKey,</b>
<b class="fc">&nbsp;        cachedProposals +</b>
<b class="fc">&nbsp;          CachedProposal(</b>
<b class="fc">&nbsp;            validations.validated(proposal).bind(),</b>
<b class="fc">&nbsp;            cipherSuite,</b>
<b class="fc">&nbsp;          ).let { it.ref.hex to it },</b>
&nbsp;      )
&nbsp;
<b class="nc">&nbsp;    fun getStoredProposals(): List&lt;CachedProposal&gt; = cachedProposals.values.toList()</b>
&nbsp;
&nbsp;    context(Raise&lt;InvalidCommit.UnknownProposal&gt;)
&nbsp;    fun getStoredProposal(proposalRef: Proposal.Ref): CachedProposal =
<b class="pc">&nbsp;      cachedProposals[proposalRef.hex]</b>
<b class="nc">&nbsp;        ?: raise(InvalidCommit.UnknownProposal(groupId, epoch, proposalRef))</b>
&nbsp;
&nbsp;    fun groupInfo(
<b class="nc">&nbsp;      inlineTree: Boolean = true,</b>
<b class="nc">&nbsp;      public: Boolean = false,</b>
&nbsp;    ): Either&lt;GroupInfoError, GroupInfo&gt; =
<b class="nc">&nbsp;      GroupInfo.create(</b>
<b class="nc">&nbsp;        groupContext,</b>
<b class="nc">&nbsp;        mac(keySchedule.confirmationKey, groupContext.confirmedTranscriptHash),</b>
<b class="nc">&nbsp;        listOfNotNull(</b>
<b class="nc">&nbsp;          if (inlineTree) RatchetTreeExt(tree) else null,</b>
<b class="nc">&nbsp;          if (public) ExternalPub(deriveKeyPair(keySchedule.externalSecret).public) else null,</b>
<b class="nc">&nbsp;          *Extension.grease(),</b>
&nbsp;        ),
<b class="nc">&nbsp;        leafIndex,</b>
<b class="nc">&nbsp;        signaturePrivateKey,</b>
&nbsp;      )
&nbsp;
&nbsp;    override suspend fun getPreSharedKey(id: PreSharedKeyId): Either&lt;PskError, Secret&gt; =
<b class="nc">&nbsp;      either {</b>
<b class="nc">&nbsp;        if (id is ResumptionPskId &amp;&amp; id.pskGroupId eq groupId &amp;&amp; id.pskEpoch == epoch) {</b>
<b class="nc">&nbsp;          keySchedule.resumptionPsk</b>
&nbsp;        } else {
<b class="nc">&nbsp;          raise(PskError.PskNotFound(id))</b>
&nbsp;        }
&nbsp;      }
&nbsp;
&nbsp;    suspend fun &lt;Identity : Any&gt; process(
&nbsp;      mlsMessage: MlsHandshakeMessage,
&nbsp;      authenticationService: AuthenticationService&lt;Identity&gt;,
<b class="nc">&nbsp;      psks: PskLookup = PskLookup.EMPTY,</b>
<b class="nc">&nbsp;      cachedState: GroupState? = null,</b>
<b class="nc">&nbsp;    ): Either&lt;ProcessMessageError, GroupState&gt; = process(mlsMessage.message, authenticationService, psks, cachedState)</b>
&nbsp;
&nbsp;    suspend fun &lt;Identity : Any&gt; process(
&nbsp;      message: HandshakeMessage,
&nbsp;      authenticationService: AuthenticationService&lt;Identity&gt;,
<b class="fc">&nbsp;      psks: PskLookup = PskLookup.EMPTY,</b>
<b class="fc">&nbsp;      cachedState: GroupState? = null,</b>
&nbsp;    ): Either&lt;ProcessMessageError, GroupState&gt; =
<b class="fc">&nbsp;      either {</b>
<b class="fc">&nbsp;        process(message.unprotect(this@Active).bind(), authenticationService, psks, cachedState)</b>
&nbsp;      }
&nbsp;
&nbsp;    context(Raise&lt;ProcessMessageError&gt;)
&nbsp;    @Suppress(&quot;UNCHECKED_CAST&quot;)
&nbsp;    internal suspend fun &lt;Identity : Any&gt; process(
&nbsp;      message: AuthHandshakeContent,
&nbsp;      authenticationService: AuthenticationService&lt;Identity&gt;,
<b class="nc">&nbsp;      psks: PskLookup = PskLookup.EMPTY,</b>
<b class="nc">&nbsp;      cachedState: GroupState? = null,</b>
&nbsp;    ): GroupState {
<b class="fc">&nbsp;      ensure(message.groupId eq groupId) { MessageRecipientError.WrongGroup(message.groupId, groupId) }</b>
<b class="fc">&nbsp;      ensure(message.epoch == epoch) {</b>
<b class="nc">&nbsp;        ProcessMessageError.HandshakeMessageForWrongEpoch(groupId, message.epoch, epoch)</b>
&nbsp;      }
&nbsp;
<b class="fc">&nbsp;      return when (message.framedContent.content) {</b>
<b class="fc">&nbsp;        is Proposal -&gt;</b>
<b class="fc">&nbsp;          storeProposal(message as AuthenticatedContent&lt;Proposal&gt;)</b>
&nbsp;
<b class="fc">&nbsp;        is Commit -&gt;</b>
<b class="pc">&nbsp;          if (message.sender.type == Member &amp;&amp; message.sender.index == leafIndex) {</b>
<b class="nc">&nbsp;            cachedState ?: raise(ProcessMessageError.MustUseCachedStateForOwnCommit)</b>
&nbsp;          } else {
<b class="fc">&nbsp;            processCommit(message as AuthenticatedContent&lt;Commit&gt;, authenticationService, psks).bind()</b>
&nbsp;          }
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    context(Raise&lt;CreateUpdateError&gt;)
&nbsp;    fun updateLeafNode(
&nbsp;      newEncryptionKeyPair: HpkeKeyPair,
<b class="nc">&nbsp;      newSignatureKeyPair: SignatureKeyPair? = null,</b>
<b class="nc">&nbsp;      newCredential: Credential? = null,</b>
<b class="nc">&nbsp;      newCapabilities: Capabilities? = null,</b>
<b class="nc">&nbsp;      newExtensions: LeafNodeExtensions? = null,</b>
&nbsp;    ): UpdateLeafNode {
<b class="nc">&nbsp;      if (cachedUpdate != null) raise(CreateUpdateError.AlreadyUpdatedThisEpoch)</b>
&nbsp;
<b class="nc">&nbsp;      val oldLeaf = tree.leafNode(leafIndex)</b>
<b class="nc">&nbsp;      val newLeaf =</b>
<b class="nc">&nbsp;        LeafNode.update(</b>
<b class="nc">&nbsp;          cipherSuite,</b>
<b class="nc">&nbsp;          newSignatureKeyPair ?: SignatureKeyPair(signaturePrivateKey, oldLeaf.signaturePublicKey),</b>
<b class="nc">&nbsp;          newEncryptionKeyPair.public,</b>
<b class="nc">&nbsp;          newCredential ?: oldLeaf.credential,</b>
<b class="nc">&nbsp;          newCapabilities ?: oldLeaf.capabilities,</b>
<b class="nc">&nbsp;          newExtensions ?: oldLeaf.extensions,</b>
<b class="nc">&nbsp;          leafIndex,</b>
<b class="nc">&nbsp;          groupId,</b>
<b class="nc">&nbsp;        ).bind()</b>
&nbsp;
<b class="nc">&nbsp;      cachedUpdate = CachedUpdate(newLeaf, newEncryptionKeyPair.private, newSignatureKeyPair?.private)</b>
&nbsp;
<b class="nc">&nbsp;      return newLeaf</b>
&nbsp;    }
&nbsp;
&nbsp;    fun nextEpoch(
&nbsp;      groupContext: GroupContext,
&nbsp;      tree: RatchetTree,
&nbsp;      keySchedule: KeySchedule,
<b class="nc">&nbsp;      newSignaturePrivateKey: SignaturePrivateKey = signaturePrivateKey,</b>
<b class="fc">&nbsp;    ): Active = Active(groupContext, tree, keySchedule, newSignaturePrivateKey)</b>
&nbsp;
&nbsp;    fun suspend(
&nbsp;      groupContext: GroupContext,
&nbsp;      tree: RatchetTree,
&nbsp;      keySchedule: KeySchedule,
&nbsp;      reInit: ReInit,
<b class="nc">&nbsp;    ): Suspended = Suspended(groupContext, tree, keySchedule, reInit)</b>
&nbsp;  }
&nbsp;
&nbsp;  class Suspended internal constructor(
&nbsp;    groupContext: GroupContext,
&nbsp;    tree: RatchetTree,
&nbsp;    keySchedule: KeySchedule,
<b class="nc">&nbsp;    val reInit: ReInit,</b>
<b class="nc">&nbsp;  ) : GroupState(groupContext, tree, keySchedule), PskLookup {</b>
&nbsp;    override suspend fun getPreSharedKey(id: PreSharedKeyId): Either&lt;PskError, Secret&gt; =
<b class="nc">&nbsp;      either {</b>
<b class="nc">&nbsp;        if (id is ResumptionPskId &amp;&amp; id.pskGroupId eq groupId &amp;&amp; id.pskEpoch == epoch) {</b>
<b class="nc">&nbsp;          keySchedule.resumptionPsk</b>
&nbsp;        } else {
<b class="nc">&nbsp;          raise(PskError.PskNotFound(id))</b>
&nbsp;        }
&nbsp;      }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  internal data class CachedUpdate(</b>
<b class="nc">&nbsp;    val leafNode: UpdateLeafNode,</b>
<b class="nc">&nbsp;    val encryptionPrivateKey: HpkePrivateKey,</b>
<b class="nc">&nbsp;    val signaturePrivateKey: SignaturePrivateKey?,</b>
&nbsp;  )
&nbsp;
<b class="fc">&nbsp;  data class CachedProposal(</b>
<b class="fc">&nbsp;    val ref: Proposal.Ref,</b>
<b class="fc">&nbsp;    val sender: LeafIndex?,</b>
<b class="fc">&nbsp;    val proposal: Proposal,</b>
<b class="fc">&nbsp;    val received: Instant = Instant.now(),</b>
&nbsp;  ) {
&nbsp;    internal constructor(
&nbsp;      proposal: AuthenticatedContent&lt;Proposal&gt;,
&nbsp;      cipherSuite: ICipherSuite,
<b class="fc">&nbsp;    ) : this(</b>
<b class="fc">&nbsp;      cipherSuite.makeProposalRef(proposal),</b>
<b class="pc">&nbsp;      proposal.sender.takeIf { it.type == Member }?.index,</b>
<b class="fc">&nbsp;      proposal.framedContent.content,</b>
&nbsp;    )
&nbsp;  }
&nbsp;
<b class="fc">&nbsp;  companion object</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-25 13:33</div>
</div>
</body>
</html>
