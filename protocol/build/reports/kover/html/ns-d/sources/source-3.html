


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>protocol Coverage Report > GroupMessageFactory</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: protocol<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.github.traderjoe95.mls.protocol.message</a>
</div>

<h1>Coverage Summary for Class: GroupMessageFactory (com.github.traderjoe95.mls.protocol.message)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">GroupMessageFactory</td>
<td class="coverageStat">
  <span class="percent">
    38.7%
  </span>
  <span class="absValue">
    (12/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    80%
  </span>
  <span class="absValue">
    (8/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    33.9%
  </span>
  <span class="absValue">
    (39/115)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    29.3%
  </span>
  <span class="absValue">
    (273/931)
  </span>
</td>
</tr>
  <tr>
    <td class="name">GroupMessageFactory$add$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$applicationMessage$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$groupContextExtensions$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$preSharedKey$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$preSharedKey$3</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$protectPrivate$2</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$reInit$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$remove$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">GroupMessageFactory$update$1</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    38.7%
  </span>
  <span class="absValue">
    (12/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    80%
  </span>
  <span class="absValue">
    (8/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    33.9%
  </span>
  <span class="absValue">
    (39/115)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    29.3%
  </span>
  <span class="absValue">
    (273/931)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.github.traderjoe95.mls.protocol.message
&nbsp;
&nbsp;import arrow.core.Either
&nbsp;import arrow.core.raise.Raise
&nbsp;import arrow.core.raise.either
&nbsp;import com.github.traderjoe95.mls.protocol.crypto.CipherSuite
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateAddError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateGroupContextExtensionsError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateMessageError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreatePreSharedKeyError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateReInitError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateRemoveError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateSignatureError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateUpdateError
&nbsp;import com.github.traderjoe95.mls.protocol.error.PrivateMessageSenderError
&nbsp;import com.github.traderjoe95.mls.protocol.error.PublicMessageSenderError
&nbsp;import com.github.traderjoe95.mls.protocol.group.GroupContext
&nbsp;import com.github.traderjoe95.mls.protocol.group.GroupState
&nbsp;import com.github.traderjoe95.mls.protocol.group.Validations
&nbsp;import com.github.traderjoe95.mls.protocol.message.padding.PaddingStrategy
&nbsp;import com.github.traderjoe95.mls.protocol.message.padding.deterministic.NoPadding
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ExternalPskId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.PskLookup
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskUsage
&nbsp;import com.github.traderjoe95.mls.protocol.tree.LeafIndex
&nbsp;import com.github.traderjoe95.mls.protocol.tree.RatchetTreeOps
&nbsp;import com.github.traderjoe95.mls.protocol.tree.SecretTree
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupContextExtension
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupId
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.Mac
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.Secret
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.SignaturePrivateKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Add
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.ApplicationData
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.AuthenticatedContent
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Commit
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Content
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.FramedContent
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.GroupContextExtensions
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.PreSharedKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.ReInit
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Remove
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Update
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.ProtocolVersion
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.WireFormat
&nbsp;import com.github.traderjoe95.mls.protocol.types.tree.UpdateLeafNode
&nbsp;
<b class="fc">&nbsp;class GroupMessageFactory internal constructor(</b>
<b class="fc">&nbsp;  private val currentTree: RatchetTreeOps,</b>
<b class="fc">&nbsp;  private val membershipKey: Secret,</b>
<b class="fc">&nbsp;  private val senderDataSecret: Secret,</b>
<b class="fc">&nbsp;  private val secretTree: SecretTree,</b>
<b class="fc">&nbsp;  private val groupContext: GroupContext,</b>
<b class="fc">&nbsp;  private val leafIndex: LeafIndex,</b>
<b class="fc">&nbsp;  private val signaturePrivateKey: SignaturePrivateKey,</b>
<b class="fc">&nbsp;  private val validations: Validations = Validations(groupContext, currentTree),</b>
&nbsp;) {
<b class="nc">&nbsp;  constructor(group: GroupState.Active) : this(</b>
<b class="nc">&nbsp;    group.tree,</b>
<b class="nc">&nbsp;    group.keySchedule.membershipKey,</b>
<b class="nc">&nbsp;    group.keySchedule.senderDataSecret,</b>
<b class="nc">&nbsp;    group.secretTree,</b>
<b class="nc">&nbsp;    group.groupContext,</b>
<b class="nc">&nbsp;    group.leafIndex,</b>
<b class="nc">&nbsp;    group.signaturePrivateKey,</b>
<b class="nc">&nbsp;    group.validations,</b>
&nbsp;  )
&nbsp;
&nbsp;  private val cipherSuite: CipherSuite
<b class="fc">&nbsp;    get() = groupContext.cipherSuite</b>
&nbsp;
<b class="fc">&nbsp;  suspend fun applicationMessage(</b>
&nbsp;    applicationData: ApplicationData,
<b class="fc">&nbsp;    options: UsePrivateMessage = UsePrivateMessage(),</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;PrivateMessageSenderError, MlsApplicationMessage&gt; =
<b class="fc">&nbsp;    either {</b>
<b class="fc">&nbsp;      protectPrivate(applicationData, options, authenticatedData)</b>
&nbsp;    }
&nbsp;
&nbsp;  context(Raise&lt;CreateAddError&gt;)
<b class="nc">&nbsp;  suspend fun add(</b>
&nbsp;    keyPackage: KeyPackage,
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateAddError, MlsProposalMessage&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      protect(</b>
<b class="nc">&nbsp;        validations.validated(Add(keyPackage)).bind(),</b>
<b class="nc">&nbsp;        options,</b>
<b class="nc">&nbsp;        authenticatedData,</b>
&nbsp;      )
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun update(</b>
&nbsp;    leafNode: UpdateLeafNode,
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateUpdateError, MlsProposalMessage&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      protect(</b>
<b class="nc">&nbsp;        validations.validated(Update(leafNode), leafIndex).bind(),</b>
<b class="nc">&nbsp;        options,</b>
<b class="nc">&nbsp;        authenticatedData,</b>
&nbsp;      )
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun remove(</b>
&nbsp;    leafIndex: LeafIndex,
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateRemoveError, MlsProposalMessage&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      protect(validations.validated(Remove(leafIndex)).bind(), options, authenticatedData)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun preSharedKey(</b>
&nbsp;    externalPskId: ByteArray,
<b class="nc">&nbsp;    psks: PskLookup? = null,</b>
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreatePreSharedKeyError, MlsProposalMessage&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      protect(</b>
<b class="nc">&nbsp;        PreSharedKey(ExternalPskId(externalPskId, cipherSuite.generateNonce(cipherSuite.hashLen))).also {</b>
<b class="nc">&nbsp;          validations.validated(it, psks = psks).bind()</b>
<b class="nc">&nbsp;        },</b>
<b class="nc">&nbsp;        options,</b>
<b class="nc">&nbsp;        authenticatedData,</b>
&nbsp;      )
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun preSharedKey(</b>
&nbsp;    pskGroupId: GroupId,
&nbsp;    pskEpoch: ULong,
<b class="nc">&nbsp;    psks: PskLookup? = null,</b>
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreatePreSharedKeyError, MlsProposalMessage&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      protect(</b>
<b class="nc">&nbsp;        PreSharedKey(</b>
<b class="nc">&nbsp;          ResumptionPskId(</b>
<b class="nc">&nbsp;            ResumptionPskUsage.Application,</b>
<b class="nc">&nbsp;            pskGroupId,</b>
<b class="nc">&nbsp;            pskEpoch,</b>
<b class="nc">&nbsp;            cipherSuite.generateNonce(cipherSuite.hashLen),</b>
&nbsp;          ),
<b class="nc">&nbsp;        ).also { validations.validated(it, psks = psks).bind() },</b>
<b class="nc">&nbsp;        options,</b>
<b class="nc">&nbsp;        authenticatedData,</b>
&nbsp;      )
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun groupContextExtensions(</b>
&nbsp;    extensions: List&lt;GroupContextExtension&lt;*&gt;&gt;,
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateGroupContextExtensionsError, MlsProposalMessage&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      protect(</b>
<b class="nc">&nbsp;        validations.validated(GroupContextExtensions(extensions)).bind(),</b>
<b class="nc">&nbsp;        options,</b>
<b class="nc">&nbsp;        authenticatedData,</b>
&nbsp;      )
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun groupContextExtensions(</b>
&nbsp;    vararg extensions: GroupContextExtension&lt;*&gt;,
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
<b class="nc">&nbsp;  ): Either&lt;CreateGroupContextExtensionsError, MlsProposalMessage&gt; = groupContextExtensions(extensions.asList(), options, authenticatedData)</b>
&nbsp;
<b class="nc">&nbsp;  suspend fun reInit(</b>
&nbsp;    cipherSuite: CipherSuite,
<b class="nc">&nbsp;    version: ProtocolVersion = ProtocolVersion.MLS_1_0,</b>
<b class="nc">&nbsp;    groupId: GroupId? = null,</b>
<b class="nc">&nbsp;    extensions: List&lt;GroupContextExtension&lt;*&gt;&gt; = listOf(),</b>
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateReInitError, MlsProposalMessage&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      protect(</b>
<b class="nc">&nbsp;        validations.validated(ReInit(groupId ?: GroupId.new(), version, cipherSuite, extensions)).bind(),</b>
<b class="nc">&nbsp;        options,</b>
<b class="nc">&nbsp;        authenticatedData,</b>
&nbsp;      )
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun reInit(</b>
&nbsp;    cipherSuite: CipherSuite,
&nbsp;    vararg extensions: GroupContextExtension&lt;*&gt;,
<b class="nc">&nbsp;    version: ProtocolVersion = ProtocolVersion.MLS_1_0,</b>
<b class="nc">&nbsp;    groupId: GroupId = GroupId.new(),</b>
<b class="nc">&nbsp;    options: MessageOptions = UsePublicMessage,</b>
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
<b class="nc">&nbsp;  ): Either&lt;CreateReInitError, MlsProposalMessage&gt; = reInit(cipherSuite, version, groupId, extensions.asList(), options, authenticatedData)</b>
&nbsp;
&nbsp;  context(Raise&lt;CreateMessageError&gt;)
<b class="fc">&nbsp;  internal suspend fun &lt;C : Content&lt;C&gt;&gt; protect(</b>
&nbsp;    content: C,
&nbsp;    options: MessageOptions,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): MlsMessage&lt;GroupMessage&lt;C&gt;&gt; =
<b class="fc">&nbsp;    when (options) {</b>
<b class="fc">&nbsp;      is UsePublicMessage -&gt; protectPublic(content, options, authenticatedData)</b>
<b class="fc">&nbsp;      is UsePrivateMessage -&gt; protectPrivate(content, options, authenticatedData)</b>
&nbsp;    }
&nbsp;
&nbsp;  context(Raise&lt;CreateMessageError&gt;)
&nbsp;  internal suspend fun protectCommit(
&nbsp;    partialCommit: AuthenticatedContent&lt;Commit&gt;,
&nbsp;    confirmationTag: Mac,
&nbsp;    options: MessageOptions,
&nbsp;  ): MlsCommitMessage =
<b class="fc">&nbsp;    when (options) {</b>
<b class="fc">&nbsp;      is UsePublicMessage -&gt; protectPublic(partialCommit.copy(confirmationTag = confirmationTag))</b>
<b class="fc">&nbsp;      is UsePrivateMessage -&gt; protectPrivate(partialCommit.copy(confirmationTag = confirmationTag), options)</b>
&nbsp;    }
&nbsp;
&nbsp;  context(Raise&lt;PublicMessageSenderError&gt;)
&nbsp;  internal fun &lt;C : Content&lt;C&gt;&gt; protectPublic(
&nbsp;    content: C,
&nbsp;    options: UsePublicMessage,
&nbsp;    authenticatedData: ByteArray,
<b class="fc">&nbsp;  ): MlsMessage&lt;PublicMessage&lt;C&gt;&gt; = protectPublic(createAuthenticatedContent(content, options, authenticatedData))</b>
&nbsp;
&nbsp;  context(Raise&lt;PrivateMessageSenderError&gt;)
&nbsp;  internal suspend fun &lt;C : Content&lt;C&gt;&gt; protectPrivate(
&nbsp;    content: C,
&nbsp;    options: UsePrivateMessage,
&nbsp;    authenticatedData: ByteArray,
<b class="fc">&nbsp;  ): MlsMessage&lt;PrivateMessage&lt;C&gt;&gt; = protectPrivate(createAuthenticatedContent(content, options, authenticatedData), options)</b>
&nbsp;
&nbsp;  context(Raise&lt;PublicMessageSenderError&gt;)
&nbsp;  internal fun &lt;C : Content&lt;C&gt;&gt; protectPublic(content: AuthenticatedContent&lt;C&gt;): MlsMessage&lt;PublicMessage&lt;C&gt;&gt; =
<b class="fc">&nbsp;    MlsMessage.public(</b>
<b class="fc">&nbsp;      PublicMessage.create(content, groupContext, membershipKey),</b>
&nbsp;    )
&nbsp;
&nbsp;  context(Raise&lt;PrivateMessageSenderError&gt;)
&nbsp;  internal suspend fun &lt;C : Content&lt;C&gt;&gt; protectPrivate(
&nbsp;    content: AuthenticatedContent&lt;C&gt;,
&nbsp;    options: UsePrivateMessage,
&nbsp;  ): MlsMessage&lt;PrivateMessage&lt;C&gt;&gt; =
<b class="fc">&nbsp;    MlsMessage.private(</b>
<b class="fc">&nbsp;      PrivateMessage.create(</b>
<b class="fc">&nbsp;        cipherSuite,</b>
<b class="fc">&nbsp;        content,</b>
<b class="fc">&nbsp;        secretTree,</b>
<b class="fc">&nbsp;        senderDataSecret,</b>
<b class="fc">&nbsp;        options.paddingStrategy,</b>
&nbsp;      ),
&nbsp;    )
&nbsp;
&nbsp;  context(Raise&lt;CreateSignatureError&gt;)
&nbsp;  internal fun &lt;C : Content&lt;C&gt;&gt; createAuthenticatedContent(
&nbsp;    content: C,
&nbsp;    options: MessageOptions,
&nbsp;    authenticatedData: ByteArray,
&nbsp;  ): AuthenticatedContent&lt;C&gt; {
<b class="fc">&nbsp;    val framedContent = FramedContent.createMember(content, groupContext, leafIndex, authenticatedData)</b>
<b class="fc">&nbsp;    val signature = framedContent.sign(options.wireFormat, groupContext, signaturePrivateKey).bind()</b>
&nbsp;
<b class="fc">&nbsp;    return AuthenticatedContent(</b>
<b class="fc">&nbsp;      options.wireFormat,</b>
<b class="fc">&nbsp;      framedContent,</b>
<b class="fc">&nbsp;      signature,</b>
<b class="fc">&nbsp;      null,</b>
&nbsp;    )
&nbsp;  }
&nbsp;}
&nbsp;
&nbsp;sealed interface MessageOptions {
&nbsp;  val wireFormat: WireFormat
&nbsp;}
&nbsp;
&nbsp;data object UsePublicMessage : MessageOptions {
&nbsp;  override val wireFormat: WireFormat = WireFormat.MlsPublicMessage
&nbsp;}
&nbsp;
&nbsp;data class UsePrivateMessage(val paddingStrategy: PaddingStrategy = NoPadding) : MessageOptions {
&nbsp;  override val wireFormat: WireFormat = WireFormat.MlsPrivateMessage
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-25 13:33</div>
</div>
</body>
</html>
