


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>protocol Coverage Report > UsePrivateMessage</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: protocol<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.github.traderjoe95.mls.protocol.message</a>
</div>

<h1>Coverage Summary for Class: UsePrivateMessage (com.github.traderjoe95.mls.protocol.message)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">UsePrivateMessage</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (22/22)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.github.traderjoe95.mls.protocol.message
&nbsp;
&nbsp;import arrow.core.Either
&nbsp;import arrow.core.raise.Raise
&nbsp;import arrow.core.raise.either
&nbsp;import com.github.traderjoe95.mls.protocol.crypto.CipherSuite
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateAddError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateGroupContextExtensionsError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateMessageError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreatePreSharedKeyError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateReInitError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateRemoveError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateSignatureError
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateUpdateError
&nbsp;import com.github.traderjoe95.mls.protocol.error.PrivateMessageSenderError
&nbsp;import com.github.traderjoe95.mls.protocol.error.PublicMessageSenderError
&nbsp;import com.github.traderjoe95.mls.protocol.group.GroupContext
&nbsp;import com.github.traderjoe95.mls.protocol.group.GroupState
&nbsp;import com.github.traderjoe95.mls.protocol.group.Validations
&nbsp;import com.github.traderjoe95.mls.protocol.message.padding.PaddingStrategy
&nbsp;import com.github.traderjoe95.mls.protocol.message.padding.deterministic.NoPadding
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ExternalPskId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.PskLookup
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskUsage
&nbsp;import com.github.traderjoe95.mls.protocol.tree.LeafIndex
&nbsp;import com.github.traderjoe95.mls.protocol.tree.RatchetTreeOps
&nbsp;import com.github.traderjoe95.mls.protocol.tree.SecretTree
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupContextExtension
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupId
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.Mac
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.Secret
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.SignaturePrivateKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Add
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.ApplicationData
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.AuthenticatedContent
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Commit
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Content
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.FramedContent
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.GroupContextExtensions
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.PreSharedKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.ReInit
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Remove
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.content.Update
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.ProtocolVersion
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.WireFormat
&nbsp;import com.github.traderjoe95.mls.protocol.types.tree.UpdateLeafNode
&nbsp;
&nbsp;class GroupMessageFactory internal constructor(
&nbsp;  private val currentTree: RatchetTreeOps,
&nbsp;  private val membershipKey: Secret,
&nbsp;  private val senderDataSecret: Secret,
&nbsp;  private val secretTree: SecretTree,
&nbsp;  private val groupContext: GroupContext,
&nbsp;  private val leafIndex: LeafIndex,
&nbsp;  private val signaturePrivateKey: SignaturePrivateKey,
&nbsp;  private val validations: Validations = Validations(groupContext, currentTree),
&nbsp;) {
&nbsp;  constructor(group: GroupState.Active) : this(
&nbsp;    group.tree,
&nbsp;    group.keySchedule.membershipKey,
&nbsp;    group.keySchedule.senderDataSecret,
&nbsp;    group.secretTree,
&nbsp;    group.groupContext,
&nbsp;    group.leafIndex,
&nbsp;    group.signaturePrivateKey,
&nbsp;    group.validations,
&nbsp;  )
&nbsp;
&nbsp;  private val cipherSuite: CipherSuite
&nbsp;    get() = groupContext.cipherSuite
&nbsp;
&nbsp;  suspend fun applicationMessage(
&nbsp;    applicationData: ApplicationData,
&nbsp;    options: UsePrivateMessage = UsePrivateMessage(),
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;PrivateMessageSenderError, MlsApplicationMessage&gt; =
&nbsp;    either {
&nbsp;      protectPrivate(applicationData, options, authenticatedData)
&nbsp;    }
&nbsp;
&nbsp;  context(Raise&lt;CreateAddError&gt;)
&nbsp;  suspend fun add(
&nbsp;    keyPackage: KeyPackage,
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateAddError, MlsProposalMessage&gt; =
&nbsp;    either {
&nbsp;      protect(
&nbsp;        validations.validated(Add(keyPackage)).bind(),
&nbsp;        options,
&nbsp;        authenticatedData,
&nbsp;      )
&nbsp;    }
&nbsp;
&nbsp;  suspend fun update(
&nbsp;    leafNode: UpdateLeafNode,
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateUpdateError, MlsProposalMessage&gt; =
&nbsp;    either {
&nbsp;      protect(
&nbsp;        validations.validated(Update(leafNode), leafIndex).bind(),
&nbsp;        options,
&nbsp;        authenticatedData,
&nbsp;      )
&nbsp;    }
&nbsp;
&nbsp;  suspend fun remove(
&nbsp;    leafIndex: LeafIndex,
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateRemoveError, MlsProposalMessage&gt; =
&nbsp;    either {
&nbsp;      protect(validations.validated(Remove(leafIndex)).bind(), options, authenticatedData)
&nbsp;    }
&nbsp;
&nbsp;  suspend fun preSharedKey(
&nbsp;    externalPskId: ByteArray,
&nbsp;    psks: PskLookup? = null,
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreatePreSharedKeyError, MlsProposalMessage&gt; =
&nbsp;    either {
&nbsp;      protect(
&nbsp;        PreSharedKey(ExternalPskId(externalPskId, cipherSuite.generateNonce(cipherSuite.hashLen))).also {
&nbsp;          validations.validated(it, psks = psks).bind()
&nbsp;        },
&nbsp;        options,
&nbsp;        authenticatedData,
&nbsp;      )
&nbsp;    }
&nbsp;
&nbsp;  suspend fun preSharedKey(
&nbsp;    pskGroupId: GroupId,
&nbsp;    pskEpoch: ULong,
&nbsp;    psks: PskLookup? = null,
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreatePreSharedKeyError, MlsProposalMessage&gt; =
&nbsp;    either {
&nbsp;      protect(
&nbsp;        PreSharedKey(
&nbsp;          ResumptionPskId(
&nbsp;            ResumptionPskUsage.Application,
&nbsp;            pskGroupId,
&nbsp;            pskEpoch,
&nbsp;            cipherSuite.generateNonce(cipherSuite.hashLen),
&nbsp;          ),
&nbsp;        ).also { validations.validated(it, psks = psks).bind() },
&nbsp;        options,
&nbsp;        authenticatedData,
&nbsp;      )
&nbsp;    }
&nbsp;
&nbsp;  suspend fun groupContextExtensions(
&nbsp;    extensions: List&lt;GroupContextExtension&lt;*&gt;&gt;,
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateGroupContextExtensionsError, MlsProposalMessage&gt; =
&nbsp;    either {
&nbsp;      protect(
&nbsp;        validations.validated(GroupContextExtensions(extensions)).bind(),
&nbsp;        options,
&nbsp;        authenticatedData,
&nbsp;      )
&nbsp;    }
&nbsp;
&nbsp;  suspend fun groupContextExtensions(
&nbsp;    vararg extensions: GroupContextExtension&lt;*&gt;,
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateGroupContextExtensionsError, MlsProposalMessage&gt; = groupContextExtensions(extensions.asList(), options, authenticatedData)
&nbsp;
&nbsp;  suspend fun reInit(
&nbsp;    cipherSuite: CipherSuite,
&nbsp;    version: ProtocolVersion = ProtocolVersion.MLS_1_0,
&nbsp;    groupId: GroupId? = null,
&nbsp;    extensions: List&lt;GroupContextExtension&lt;*&gt;&gt; = listOf(),
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateReInitError, MlsProposalMessage&gt; =
&nbsp;    either {
&nbsp;      protect(
&nbsp;        validations.validated(ReInit(groupId ?: GroupId.new(), version, cipherSuite, extensions)).bind(),
&nbsp;        options,
&nbsp;        authenticatedData,
&nbsp;      )
&nbsp;    }
&nbsp;
&nbsp;  suspend fun reInit(
&nbsp;    cipherSuite: CipherSuite,
&nbsp;    vararg extensions: GroupContextExtension&lt;*&gt;,
&nbsp;    version: ProtocolVersion = ProtocolVersion.MLS_1_0,
&nbsp;    groupId: GroupId = GroupId.new(),
&nbsp;    options: MessageOptions = UsePublicMessage,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): Either&lt;CreateReInitError, MlsProposalMessage&gt; = reInit(cipherSuite, version, groupId, extensions.asList(), options, authenticatedData)
&nbsp;
&nbsp;  context(Raise&lt;CreateMessageError&gt;)
&nbsp;  internal suspend fun &lt;C : Content&lt;C&gt;&gt; protect(
&nbsp;    content: C,
&nbsp;    options: MessageOptions,
&nbsp;    authenticatedData: ByteArray = byteArrayOf(),
&nbsp;  ): MlsMessage&lt;GroupMessage&lt;C&gt;&gt; =
&nbsp;    when (options) {
&nbsp;      is UsePublicMessage -&gt; protectPublic(content, options, authenticatedData)
&nbsp;      is UsePrivateMessage -&gt; protectPrivate(content, options, authenticatedData)
&nbsp;    }
&nbsp;
&nbsp;  context(Raise&lt;CreateMessageError&gt;)
&nbsp;  internal suspend fun protectCommit(
&nbsp;    partialCommit: AuthenticatedContent&lt;Commit&gt;,
&nbsp;    confirmationTag: Mac,
&nbsp;    options: MessageOptions,
&nbsp;  ): MlsCommitMessage =
&nbsp;    when (options) {
&nbsp;      is UsePublicMessage -&gt; protectPublic(partialCommit.copy(confirmationTag = confirmationTag))
&nbsp;      is UsePrivateMessage -&gt; protectPrivate(partialCommit.copy(confirmationTag = confirmationTag), options)
&nbsp;    }
&nbsp;
&nbsp;  context(Raise&lt;PublicMessageSenderError&gt;)
&nbsp;  internal fun &lt;C : Content&lt;C&gt;&gt; protectPublic(
&nbsp;    content: C,
&nbsp;    options: UsePublicMessage,
&nbsp;    authenticatedData: ByteArray,
&nbsp;  ): MlsMessage&lt;PublicMessage&lt;C&gt;&gt; = protectPublic(createAuthenticatedContent(content, options, authenticatedData))
&nbsp;
&nbsp;  context(Raise&lt;PrivateMessageSenderError&gt;)
&nbsp;  internal suspend fun &lt;C : Content&lt;C&gt;&gt; protectPrivate(
&nbsp;    content: C,
&nbsp;    options: UsePrivateMessage,
&nbsp;    authenticatedData: ByteArray,
&nbsp;  ): MlsMessage&lt;PrivateMessage&lt;C&gt;&gt; = protectPrivate(createAuthenticatedContent(content, options, authenticatedData), options)
&nbsp;
&nbsp;  context(Raise&lt;PublicMessageSenderError&gt;)
&nbsp;  internal fun &lt;C : Content&lt;C&gt;&gt; protectPublic(content: AuthenticatedContent&lt;C&gt;): MlsMessage&lt;PublicMessage&lt;C&gt;&gt; =
&nbsp;    MlsMessage.public(
&nbsp;      PublicMessage.create(content, groupContext, membershipKey),
&nbsp;    )
&nbsp;
&nbsp;  context(Raise&lt;PrivateMessageSenderError&gt;)
&nbsp;  internal suspend fun &lt;C : Content&lt;C&gt;&gt; protectPrivate(
&nbsp;    content: AuthenticatedContent&lt;C&gt;,
&nbsp;    options: UsePrivateMessage,
&nbsp;  ): MlsMessage&lt;PrivateMessage&lt;C&gt;&gt; =
&nbsp;    MlsMessage.private(
&nbsp;      PrivateMessage.create(
&nbsp;        cipherSuite,
&nbsp;        content,
&nbsp;        secretTree,
&nbsp;        senderDataSecret,
&nbsp;        options.paddingStrategy,
&nbsp;      ),
&nbsp;    )
&nbsp;
&nbsp;  context(Raise&lt;CreateSignatureError&gt;)
&nbsp;  internal fun &lt;C : Content&lt;C&gt;&gt; createAuthenticatedContent(
&nbsp;    content: C,
&nbsp;    options: MessageOptions,
&nbsp;    authenticatedData: ByteArray,
&nbsp;  ): AuthenticatedContent&lt;C&gt; {
&nbsp;    val framedContent = FramedContent.createMember(content, groupContext, leafIndex, authenticatedData)
&nbsp;    val signature = framedContent.sign(options.wireFormat, groupContext, signaturePrivateKey).bind()
&nbsp;
&nbsp;    return AuthenticatedContent(
&nbsp;      options.wireFormat,
&nbsp;      framedContent,
&nbsp;      signature,
&nbsp;      null,
&nbsp;    )
&nbsp;  }
&nbsp;}
&nbsp;
&nbsp;sealed interface MessageOptions {
&nbsp;  val wireFormat: WireFormat
&nbsp;}
&nbsp;
&nbsp;data object UsePublicMessage : MessageOptions {
&nbsp;  override val wireFormat: WireFormat = WireFormat.MlsPublicMessage
&nbsp;}
&nbsp;
<b class="fc">&nbsp;data class UsePrivateMessage(val paddingStrategy: PaddingStrategy = NoPadding) : MessageOptions {</b>
<b class="fc">&nbsp;  override val wireFormat: WireFormat = WireFormat.MlsPrivateMessage</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-25 13:33</div>
</div>
</body>
</html>
