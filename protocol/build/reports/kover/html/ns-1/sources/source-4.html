


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>protocol Coverage Report > MlsClient</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: protocol<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.github.traderjoe95.mls.protocol.client</a>
</div>

<h1>Coverage Summary for Class: MlsClient (com.github.traderjoe95.mls.protocol.client)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">MlsClient</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    5%
  </span>
  <span class="absValue">
    (2/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/127)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.5%
  </span>
  <span class="absValue">
    (4/782)
  </span>
</td>
</tr>
  <tr>
    <td class="name">MlsClient$getPreSharedKey$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MlsClient$joinFromGroupInfo$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MlsClient$joinFromGroupInfo$3</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MlsClient$joinFromWelcome$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MlsClient$processGroupMessage$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MlsClient$processGroupMessage$3</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MlsClient$processMessage$3</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    5%
  </span>
  <span class="absValue">
    (2/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/127)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.5%
  </span>
  <span class="absValue">
    (4/782)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.github.traderjoe95.mls.protocol.client
&nbsp;
&nbsp;import arrow.core.Either
&nbsp;import arrow.core.flatMap
&nbsp;import arrow.core.raise.either
&nbsp;import com.github.traderjoe95.mls.protocol.crypto.CipherSuite
&nbsp;import com.github.traderjoe95.mls.protocol.error.CreateSignatureError
&nbsp;import com.github.traderjoe95.mls.protocol.error.DecoderError
&nbsp;import com.github.traderjoe95.mls.protocol.error.ExternalJoinError
&nbsp;import com.github.traderjoe95.mls.protocol.error.ExternalPskError
&nbsp;import com.github.traderjoe95.mls.protocol.error.GroupCreationError
&nbsp;import com.github.traderjoe95.mls.protocol.error.GroupSuspended
&nbsp;import com.github.traderjoe95.mls.protocol.error.ProcessMessageError
&nbsp;import com.github.traderjoe95.mls.protocol.error.PskError
&nbsp;import com.github.traderjoe95.mls.protocol.error.PublicMessageError
&nbsp;import com.github.traderjoe95.mls.protocol.error.UnknownGroup
&nbsp;import com.github.traderjoe95.mls.protocol.error.WelcomeJoinError
&nbsp;import com.github.traderjoe95.mls.protocol.group.resumption.isProtocolResumption
&nbsp;import com.github.traderjoe95.mls.protocol.message.ApplicationMessage
&nbsp;import com.github.traderjoe95.mls.protocol.message.GroupInfo
&nbsp;import com.github.traderjoe95.mls.protocol.message.GroupMessage
&nbsp;import com.github.traderjoe95.mls.protocol.message.HandshakeMessage
&nbsp;import com.github.traderjoe95.mls.protocol.message.KeyPackage
&nbsp;import com.github.traderjoe95.mls.protocol.message.MlsMessage
&nbsp;import com.github.traderjoe95.mls.protocol.message.MlsMessage.Companion.ensureFormat
&nbsp;import com.github.traderjoe95.mls.protocol.message.PublicMessage
&nbsp;import com.github.traderjoe95.mls.protocol.message.Welcome
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ExternalPskHolder
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ExternalPskId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.PreSharedKeyId
&nbsp;import com.github.traderjoe95.mls.protocol.psk.ResumptionPskId
&nbsp;import com.github.traderjoe95.mls.protocol.service.AuthenticationService
&nbsp;import com.github.traderjoe95.mls.protocol.tree.PublicRatchetTree
&nbsp;import com.github.traderjoe95.mls.protocol.types.Credential
&nbsp;import com.github.traderjoe95.mls.protocol.types.GroupId
&nbsp;import com.github.traderjoe95.mls.protocol.types.KeyPackageExtensions
&nbsp;import com.github.traderjoe95.mls.protocol.types.LeafNodeExtensions
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.Secret
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.SignatureKeyPair
&nbsp;import com.github.traderjoe95.mls.protocol.types.framing.enums.ContentType
&nbsp;import com.github.traderjoe95.mls.protocol.types.tree.leaf.Capabilities
&nbsp;import com.github.traderjoe95.mls.protocol.types.tree.leaf.Lifetime
&nbsp;import com.github.traderjoe95.mls.protocol.util.hex
&nbsp;
<b class="nc">&nbsp;class MlsClient&lt;Identity : Any&gt;(</b>
<b class="nc">&nbsp;  val authenticationService: AuthenticationService&lt;Identity&gt;,</b>
&nbsp;) : ExternalPskHolder&lt;MlsClient&lt;Identity&gt;&gt; {
<b class="nc">&nbsp;  private val groups: MutableMap&lt;String, GroupClient&lt;Identity, *&gt;&gt; = mutableMapOf()</b>
<b class="nc">&nbsp;  private val externalPsks: MutableMap&lt;String, Secret&gt; = mutableMapOf()</b>
&nbsp;
&nbsp;  fun createGroup(
&nbsp;    cipherSuite: CipherSuite,
&nbsp;    signatureKeyPair: SignatureKeyPair,
&nbsp;    credential: Credential,
<b class="nc">&nbsp;    groupId: GroupId? = null,</b>
<b class="nc">&nbsp;    capabilities: Capabilities = Capabilities.default(),</b>
<b class="nc">&nbsp;    keyPackageExtensions: KeyPackageExtensions = listOf(),</b>
<b class="nc">&nbsp;    leafNodeExtensions: LeafNodeExtensions = listOf(),</b>
&nbsp;  ): Either&lt;GroupCreationError, ActiveGroupClient&lt;Identity&gt;&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      GroupClient.newGroup(</b>
<b class="nc">&nbsp;        this@MlsClient,</b>
<b class="nc">&nbsp;        KeyPackage</b>
<b class="nc">&nbsp;          .generate(</b>
<b class="nc">&nbsp;            cipherSuite,</b>
<b class="nc">&nbsp;            signatureKeyPair.move(),</b>
<b class="nc">&nbsp;            credential,</b>
<b class="nc">&nbsp;            capabilities = capabilities,</b>
<b class="nc">&nbsp;            lifetime = Lifetime.always(),</b>
<b class="nc">&nbsp;            keyPackageExtensions = keyPackageExtensions,</b>
<b class="nc">&nbsp;            leafNodeExtensions = leafNodeExtensions,</b>
&nbsp;          )
<b class="nc">&nbsp;          .bind(),</b>
<b class="nc">&nbsp;        groupId = groupId,</b>
<b class="nc">&nbsp;      ).bind()</b>
&nbsp;    }
&nbsp;
&nbsp;  suspend fun joinFromWelcome(
&nbsp;    welcome: Welcome,
&nbsp;    ownKeyPackage: KeyPackage.Private,
<b class="nc">&nbsp;    optionalTree: PublicRatchetTree? = null,</b>
&nbsp;  ): Either&lt;WelcomeJoinError, ActiveGroupClient&lt;Identity&gt;&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      val resumingFrom =</b>
<b class="nc">&nbsp;        welcome.decryptGroupSecrets(ownKeyPackage)</b>
<b class="nc">&nbsp;          .bind()</b>
<b class="nc">&nbsp;          .preSharedKeyIds</b>
<b class="nc">&nbsp;          .filterIsInstance&lt;ResumptionPskId&gt;()</b>
<b class="nc">&nbsp;          .find { it.isProtocolResumption }</b>
<b class="nc">&nbsp;          ?.let {</b>
<b class="nc">&nbsp;            groups[it.pskGroupId.hex]</b>
<b class="nc">&nbsp;              ?.getStateForEpoch(it.pskGroupId, it.pskEpoch)</b>
<b class="nc">&nbsp;              ?: raise(WelcomeJoinError.MissingResumptionGroup(it))</b>
&nbsp;          }
&nbsp;
<b class="nc">&nbsp;      GroupClient.joinFromWelcome(</b>
<b class="nc">&nbsp;        this@MlsClient,</b>
<b class="nc">&nbsp;        welcome,</b>
<b class="nc">&nbsp;        ownKeyPackage,</b>
<b class="nc">&nbsp;        resumingFrom,</b>
<b class="nc">&nbsp;        optionalTree,</b>
<b class="nc">&nbsp;      ).bind().also { register(it) }</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun joinFromGroupInfo(</b>
&nbsp;    groupInfo: GroupInfo,
&nbsp;    signatureKeyPair: SignatureKeyPair,
&nbsp;    credential: Credential,
<b class="nc">&nbsp;    lifetime: Lifetime = Lifetime.always(),</b>
<b class="nc">&nbsp;    capabilities: Capabilities = Capabilities.default(),</b>
<b class="nc">&nbsp;    keyPackageExtensions: KeyPackageExtensions = listOf(),</b>
<b class="nc">&nbsp;    leafNodeExtensions: LeafNodeExtensions = listOf(),</b>
&nbsp;    commitAuthenticatedData: ByteArray = byteArrayOf(),
<b class="nc">&nbsp;    optionalTree: PublicRatchetTree? = null,</b>
&nbsp;  ): Either&lt;ExternalJoinError, Pair&lt;ActiveGroupClient&lt;Identity&gt;, ByteArray&gt;&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      joinFromGroupInfo(</b>
<b class="nc">&nbsp;        groupInfo,</b>
<b class="nc">&nbsp;        newKeyPackage(</b>
<b class="nc">&nbsp;          groupInfo.cipherSuite,</b>
<b class="nc">&nbsp;          signatureKeyPair,</b>
<b class="nc">&nbsp;          credential,</b>
<b class="nc">&nbsp;          lifetime,</b>
<b class="nc">&nbsp;          capabilities,</b>
<b class="nc">&nbsp;          keyPackageExtensions,</b>
<b class="nc">&nbsp;          leafNodeExtensions,</b>
<b class="nc">&nbsp;        ).bind(),</b>
<b class="nc">&nbsp;        commitAuthenticatedData,</b>
<b class="nc">&nbsp;        optionalTree,</b>
<b class="nc">&nbsp;      ).bind()</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  suspend fun joinFromGroupInfo(</b>
&nbsp;    groupInfo: GroupInfo,
&nbsp;    ownKeyPackage: KeyPackage.Private,
&nbsp;    commitAuthenticatedData: ByteArray = byteArrayOf(),
<b class="nc">&nbsp;    optionalTree: PublicRatchetTree? = null,</b>
&nbsp;  ): Either&lt;ExternalJoinError, Pair&lt;ActiveGroupClient&lt;Identity&gt;, ByteArray&gt;&gt; =
<b class="nc">&nbsp;    GroupClient.joinFromGroupInfo(</b>
<b class="nc">&nbsp;      this@MlsClient,</b>
<b class="nc">&nbsp;      groupInfo,</b>
<b class="nc">&nbsp;      ownKeyPackage,</b>
<b class="nc">&nbsp;      commitAuthenticatedData,</b>
<b class="nc">&nbsp;      optionalTree,</b>
<b class="nc">&nbsp;    ).onRight { (client, _) -&gt; register(client) }</b>
&nbsp;
&nbsp;  @JvmOverloads
&nbsp;  fun newKeyPackage(
&nbsp;    cipherSuite: CipherSuite,
&nbsp;    signatureKeyPair: SignatureKeyPair,
&nbsp;    credential: Credential,
<b class="nc">&nbsp;    lifetime: Lifetime = Lifetime.always(),</b>
<b class="nc">&nbsp;    capabilities: Capabilities = Capabilities.default(),</b>
<b class="nc">&nbsp;    keyPackageExtensions: KeyPackageExtensions = listOf(),</b>
<b class="nc">&nbsp;    leafNodeExtensions: LeafNodeExtensions = listOf(),</b>
&nbsp;  ): Either&lt;CreateSignatureError, KeyPackage.Private&gt; =
<b class="nc">&nbsp;    KeyPackage</b>
<b class="nc">&nbsp;      .generate(</b>
<b class="nc">&nbsp;        cipherSuite,</b>
<b class="nc">&nbsp;        signatureKeyPair.move(),</b>
<b class="nc">&nbsp;        credential,</b>
<b class="nc">&nbsp;        capabilities,</b>
<b class="nc">&nbsp;        lifetime,</b>
<b class="nc">&nbsp;        keyPackageExtensions,</b>
<b class="nc">&nbsp;        leafNodeExtensions,</b>
&nbsp;      )
&nbsp;
<b class="nc">&nbsp;  fun decodeMessage(messageBytes: ByteArray): Either&lt;DecoderError, MlsMessage&lt;*&gt;&gt; = GroupClient.decodeMessage(messageBytes)</b>
&nbsp;
&nbsp;  suspend fun processMessage(messageBytes: ByteArray): Either&lt;ProcessMessageError, ProcessMessageResult&lt;Identity&gt;&gt; =
<b class="nc">&nbsp;    decodeMessage(messageBytes)</b>
<b class="nc">&nbsp;      .flatMap { processMessage(it) }</b>
&nbsp;
&nbsp;  suspend fun processMessage(message: MlsMessage&lt;*&gt;): Either&lt;ProcessMessageError, ProcessMessageResult&lt;Identity&gt;&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      when (message.message) {</b>
<b class="nc">&nbsp;        is KeyPackage -&gt; ProcessMessageResult.KeyPackageMessageReceived(message.message)</b>
<b class="nc">&nbsp;        is Welcome -&gt; ProcessMessageResult.WelcomeMessageReceived(message.message)</b>
<b class="nc">&nbsp;        is GroupInfo -&gt; ProcessMessageResult.GroupInfoMessageReceived(message.message)</b>
<b class="nc">&nbsp;        is GroupMessage&lt;*&gt; -&gt; processGroupMessage(message.message).bind()</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;  suspend fun processGroupMessage(groupMessageBytes: ByteArray): Either&lt;ProcessMessageError, ProcessMessageResult&lt;Identity&gt;&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      val msg = decodeMessage(groupMessageBytes).bind().ensureFormat&lt;GroupMessage&lt;*&gt;&gt;()</b>
<b class="nc">&nbsp;      processGroupMessage(msg.message).bind()</b>
&nbsp;    }
&nbsp;
&nbsp;  @Suppress(&quot;UNCHECKED_CAST&quot;)
&nbsp;  suspend fun processGroupMessage(groupMessage: GroupMessage&lt;*&gt;): Either&lt;ProcessMessageError, ProcessMessageResult&lt;Identity&gt;&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      val groupId = groupMessage.groupId</b>
<b class="nc">&nbsp;      val group = groups[groupId.hex] ?: raise(UnknownGroup(groupId))</b>
&nbsp;
<b class="nc">&nbsp;      when (groupMessage.contentType) {</b>
<b class="nc">&nbsp;        is ContentType.Handshake -&gt;</b>
<b class="nc">&nbsp;          if (group is ActiveGroupClient&lt;Identity&gt;) {</b>
<b class="nc">&nbsp;            ProcessMessageResult.HandshakeMessageReceived(</b>
<b class="nc">&nbsp;              groupId,</b>
<b class="nc">&nbsp;              group.processHandshake(groupMessage as HandshakeMessage).bind(),</b>
&nbsp;            )
&nbsp;          } else {
<b class="nc">&nbsp;            raise(GroupSuspended(groupMessage.groupId))</b>
&nbsp;          }
&nbsp;
<b class="nc">&nbsp;        is ContentType.Application -&gt;</b>
<b class="nc">&nbsp;          if (groupMessage is PublicMessage) {</b>
<b class="nc">&nbsp;            raise(PublicMessageError.ApplicationMessageMustNotBePublic)</b>
&nbsp;          } else {
<b class="nc">&nbsp;            ProcessMessageResult.ApplicationMessageReceived(</b>
<b class="nc">&nbsp;              groupId,</b>
<b class="nc">&nbsp;              group.open(groupMessage as ApplicationMessage).bind(),</b>
&nbsp;            )
&nbsp;          }
&nbsp;
&nbsp;        else -&gt;
<b class="nc">&nbsp;          error(&quot;unreachable&quot;)</b>
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;  operator fun get(groupId: GroupId): GroupClient&lt;Identity, *&gt;? = groups[groupId.hex]</b>
&nbsp;
&nbsp;  override fun registerExternalPsk(
&nbsp;    pskId: ByteArray,
&nbsp;    psk: Secret,
&nbsp;  ): MlsClient&lt;Identity&gt; =
<b class="nc">&nbsp;    apply {</b>
<b class="nc">&nbsp;      externalPsks[pskId.hex] = psk</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
<b class="nc">&nbsp;  override fun deleteExternalPsk(pskId: ByteArray): MlsClient&lt;Identity&gt; = apply { externalPsks.remove(pskId.hex) }</b>
&nbsp;
<b class="nc">&nbsp;  override fun clearExternalPsks(): MlsClient&lt;Identity&gt; = apply { externalPsks.clear() }</b>
&nbsp;
&nbsp;  override suspend fun getPreSharedKey(id: PreSharedKeyId): Either&lt;PskError, Secret&gt; =
<b class="nc">&nbsp;    either {</b>
<b class="nc">&nbsp;      when (id) {</b>
<b class="nc">&nbsp;        is ExternalPskId -&gt; externalPsks[id.pskId.hex] ?: raise(ExternalPskError.UnknownExternalPsk(id.pskId))</b>
<b class="nc">&nbsp;        is ResumptionPskId -&gt;</b>
<b class="nc">&nbsp;          groups[id.pskGroupId.hex]?.getPreSharedKey(id)?.bind()</b>
<b class="nc">&nbsp;            ?: raise(UnknownGroup(id.pskGroupId))</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;  internal fun register(groupClient: GroupClient&lt;Identity, *&gt;) {
<b class="nc">&nbsp;    groups[groupClient.groupId.hex] = groupClient</b>
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-25 13:33</div>
</div>
</body>
</html>
