


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>protocol Coverage Report > DhKem</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: protocol<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.github.traderjoe95.mls.protocol.crypto.impl</a>
</div>

<h1>Coverage Summary for Class: DhKem (com.github.traderjoe95.mls.protocol.crypto.impl)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">DhKem</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    84.6%
  </span>
  <span class="absValue">
    (22/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    93.5%
  </span>
  <span class="absValue">
    (58/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    97.4%
  </span>
  <span class="absValue">
    (375/385)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DhKem$Companion</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DhKem$deriveKeyPair$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DhKem$deriveKeyPair$1$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (37/37)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DhKem$deriveKeyPair$1$4</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (33/33)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DhKem$domainParams$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (2/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    84%
  </span>
  <span class="absValue">
    (21/25)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DhKem$domainParams$2$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">DhKem$suiteId$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (10/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DhKem$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    92.9%
  </span>
  <span class="absValue">
    (13/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    86.2%
  </span>
  <span class="absValue">
    (25/29)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    92.1%
  </span>
  <span class="absValue">
    (70/76)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    96.4%
  </span>
  <span class="absValue">
    (478/496)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.github.traderjoe95.mls.protocol.crypto.impl
&nbsp;
&nbsp;import com.github.traderjoe95.mls.codec.type.uint16
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.HpkeKeyPair
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.HpkePrivateKey
&nbsp;import com.github.traderjoe95.mls.protocol.types.crypto.HpkePublicKey
&nbsp;import org.bouncycastle.asn1.x9.ECNamedCurveTable
&nbsp;import org.bouncycastle.crypto.AsymmetricCipherKeyPair
&nbsp;import org.bouncycastle.crypto.hpke.HPKE
&nbsp;import org.bouncycastle.crypto.params.ECDomainParameters
&nbsp;import org.bouncycastle.crypto.params.ECNamedDomainParameters
&nbsp;import org.bouncycastle.crypto.params.ECPrivateKeyParameters
&nbsp;import org.bouncycastle.crypto.params.ECPublicKeyParameters
&nbsp;import org.bouncycastle.crypto.params.X25519PrivateKeyParameters
&nbsp;import org.bouncycastle.crypto.params.X448PrivateKeyParameters
&nbsp;import org.bouncycastle.math.ec.FixedPointCombMultiplier
&nbsp;import org.bouncycastle.math.ec.WNafUtil
&nbsp;import java.math.BigInteger
&nbsp;import java.security.SecureRandom
&nbsp;
<b class="fc">&nbsp;internal enum class DhKem(val id: Short, val hash: HashFunction, private val curveName: String = &quot;n/a&quot;) {</b>
<b class="fc">&nbsp;  P256_SHA256(HPKE.kem_P256_SHA256, HashFunction.SHA256, &quot;P-256&quot;),</b>
<b class="fc">&nbsp;  P384_SHA384(HPKE.kem_P384_SHA348, HashFunction.SHA384, &quot;P-384&quot;),</b>
<b class="fc">&nbsp;  P521_SHA512(HPKE.kem_P521_SHA512, HashFunction.SHA512, &quot;P-521&quot;),</b>
<b class="fc">&nbsp;  X25519_SHA256(HPKE.kem_X25519_SHA256, HashFunction.SHA256),</b>
<b class="fc">&nbsp;  X448_SHA512(HPKE.kem_X448_SHA512, HashFunction.SHA512),</b>
&nbsp;  ;
&nbsp;
&nbsp;  val nsk: UShort
&nbsp;    get() =
<b class="fc">&nbsp;      when (this) {</b>
<b class="fc">&nbsp;        P256_SHA256 -&gt; 32U</b>
<b class="fc">&nbsp;        P384_SHA384 -&gt; 48U</b>
<b class="fc">&nbsp;        P521_SHA512 -&gt; 66U</b>
<b class="fc">&nbsp;        X25519_SHA256 -&gt; 32U</b>
<b class="fc">&nbsp;        X448_SHA512 -&gt; 56U</b>
&nbsp;      }
&nbsp;
&nbsp;  private val bitmask: Byte
&nbsp;    get() =
<b class="pc">&nbsp;      when (this) {</b>
<b class="fc">&nbsp;        P256_SHA256, P384_SHA384 -&gt; 0xff.toByte()</b>
<b class="fc">&nbsp;        P521_SHA512 -&gt; 0x01</b>
<b class="nc">&nbsp;        else -&gt; 0</b>
&nbsp;      }
&nbsp;
<b class="fc">&nbsp;  val domainParams: ECDomainParameters by lazy {</b>
<b class="pc">&nbsp;    when (this) {</b>
&nbsp;      P256_SHA256, P384_SHA384, P521_SHA512 -&gt;
<b class="fc">&nbsp;        ECNamedCurveTable.getOID(curveName).let { oid -&gt; ECNamedDomainParameters(oid, ECNamedCurveTable.getByOID(oid)) }</b>
&nbsp;
<b class="nc">&nbsp;      else -&gt; error(&quot;unreachable&quot;)</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="fc">&nbsp;  private val suiteId: ByteArray by lazy { &quot;KEM&quot;.encodeToByteArray() + uint16(id.toUShort()).encode() }</b>
&nbsp;
<b class="fc">&nbsp;  fun generatePrivateKey(): AsymmetricCipherKeyPair = deriveKeyPair(ByteArray(nsk.toInt()).also(RANDOM::nextBytes))</b>
&nbsp;
&nbsp;  fun deriveKeyPair(ikm: ByteArray): AsymmetricCipherKeyPair =
<b class="fc">&nbsp;    Hkdf(hash).let { hkdf -&gt;</b>
<b class="fc">&nbsp;      when (this) {</b>
&nbsp;        P256_SHA256, P384_SHA384, P521_SHA512 -&gt; {
<b class="fc">&nbsp;          val dkpPrk = hkdf.labeledExtract(null, suiteId, &quot;dkp_prk&quot;, ikm)</b>
<b class="fc">&nbsp;          val counterArray = ByteArray(1)</b>
&nbsp;
<b class="pc">&nbsp;          generateSequence(0) { it + 1 }</b>
<b class="fc">&nbsp;            .take(256)</b>
<b class="fc">&nbsp;            .map { counter -&gt;</b>
<b class="fc">&nbsp;              counterArray[0] = counter.toByte()</b>
<b class="fc">&nbsp;              val bytes = hkdf.labeledExpand(dkpPrk, suiteId, &quot;candidate&quot;, counterArray, nsk)</b>
<b class="fc">&nbsp;              bytes[0] = (bytes[0].toInt() and bitmask.toInt()).toByte()</b>
&nbsp;
&nbsp;              // generating keypair
<b class="fc">&nbsp;              BigInteger(1, bytes)</b>
&nbsp;            }
<b class="fc">&nbsp;            .filter(::validateSk)</b>
<b class="fc">&nbsp;            .map { d -&gt;</b>
<b class="fc">&nbsp;              val q = FixedPointCombMultiplier().multiply(domainParams.g, d)</b>
<b class="fc">&nbsp;              val sk = ECPrivateKeyParameters(d, domainParams)</b>
<b class="fc">&nbsp;              val pk = ECPublicKeyParameters(q, domainParams)</b>
<b class="fc">&nbsp;              AsymmetricCipherKeyPair(pk, sk)</b>
&nbsp;            }
<b class="fc">&nbsp;            .firstOrNull()</b>
<b class="nc">&nbsp;            ?: error(&quot;DeriveKeyPairError&quot;)</b>
&nbsp;        }
&nbsp;
&nbsp;        X25519_SHA256 -&gt; {
<b class="fc">&nbsp;          val dkpPrk = hkdf.labeledExtract(null, suiteId, &quot;dkp_prk&quot;, ikm)</b>
<b class="fc">&nbsp;          val skBytes = hkdf.labeledExpand(dkpPrk, suiteId, &quot;sk&quot;, null, nsk)</b>
<b class="fc">&nbsp;          val sk = X25519PrivateKeyParameters(skBytes)</b>
&nbsp;
<b class="fc">&nbsp;          return AsymmetricCipherKeyPair(sk.generatePublicKey(), sk)</b>
&nbsp;        }
&nbsp;
&nbsp;        X448_SHA512 -&gt; {
<b class="fc">&nbsp;          val dkpPrk = hkdf.labeledExtract(null, suiteId, &quot;dkp_prk&quot;, ikm)</b>
<b class="fc">&nbsp;          val x448sk = hkdf.labeledExpand(dkpPrk, suiteId, &quot;sk&quot;, null, nsk)</b>
<b class="fc">&nbsp;          val x448params = X448PrivateKeyParameters(x448sk)</b>
&nbsp;
<b class="fc">&nbsp;          AsymmetricCipherKeyPair(x448params.generatePublicKey(), x448params)</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;  fun reconstructPublicKey(privateKey: HpkePrivateKey): HpkeKeyPair =
<b class="fc">&nbsp;    HpkeKeyPair(</b>
<b class="fc">&nbsp;      privateKey,</b>
<b class="fc">&nbsp;      when (this) {</b>
&nbsp;        P256_SHA256, P384_SHA384, P521_SHA512 -&gt;
<b class="fc">&nbsp;          HpkePublicKey(</b>
<b class="fc">&nbsp;            FixedPointCombMultiplier()</b>
<b class="fc">&nbsp;              .multiply(domainParams.g, BigInteger(1, privateKey.bytes))</b>
<b class="fc">&nbsp;              .getEncoded(false),</b>
&nbsp;          )
&nbsp;
&nbsp;        X25519_SHA256 -&gt;
<b class="fc">&nbsp;          HpkePublicKey(</b>
<b class="fc">&nbsp;            X25519PrivateKeyParameters(privateKey.bytes)</b>
<b class="fc">&nbsp;              .generatePublicKey()</b>
<b class="fc">&nbsp;              .encoded,</b>
&nbsp;          )
&nbsp;
&nbsp;        X448_SHA512 -&gt;
<b class="fc">&nbsp;          HpkePublicKey(</b>
<b class="fc">&nbsp;            X448PrivateKeyParameters(privateKey.bytes)</b>
<b class="fc">&nbsp;              .generatePublicKey()</b>
<b class="fc">&nbsp;              .encoded,</b>
&nbsp;          )
&nbsp;      },
&nbsp;    )
&nbsp;
&nbsp;  private fun validateSk(d: BigInteger): Boolean {
<b class="fc">&nbsp;    val n = domainParams.n</b>
<b class="fc">&nbsp;    val nBitLength = n.bitLength()</b>
<b class="fc">&nbsp;    val minWeight = nBitLength ushr 2</b>
&nbsp;
<b class="pc">&nbsp;    if (d &lt; BigInteger.ONE || d &gt;= n) {</b>
<b class="nc">&nbsp;      return false</b>
&nbsp;    }
&nbsp;
<b class="pc">&nbsp;    if (WNafUtil.getNafWeight(d) &lt; minWeight) {</b>
<b class="nc">&nbsp;      return false</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    return true</b>
&nbsp;  }
&nbsp;
<b class="fc">&nbsp;  companion object {</b>
<b class="fc">&nbsp;    private val RANDOM = SecureRandom()</b>
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-25 13:33</div>
</div>
</body>
</html>
